kako bi to primjenio ovdje @model _2DRakun.Models.ViewModels.InvoiceViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Kreiranje računa";
}

<div class="invoice-create shadow-sm rounded bg-white p-4">
    <h2 class="text-center mb-4">Novi račun</h2>

    <form method="post" action="@Url.Action("CreateInvoice", "Home")" novalidate>
        @Html.AntiForgeryToken()

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="InvoiceNumber" class="form-label">Broj računa</label>
                <input type="text" id="InvoiceNumber" name="InvoiceNumber" class="form-control" required
                       value="@Model.InvoiceNumber" />
            </div>
        </div>

        <h3>Podaci o kupcu</h3>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="CustomerId" class="form-label">Kupac</label>
                <select id="CustomerId" name="CustomerId" class="form-select" required>
                    <option value="" selected>Odaberite kupca</option>
                    @foreach (var customer in Model.ExistingCustomers)
                    {
                        <option value="@customer.Id"
                                data-oib="@customer.Oib"
                                data-name="@customer.Name"
                                data-street="@customer.Street"
                                data-postal="@customer.PostalCode"
                                data-city="@customer.City"
                                data-email="@customer.Email"
                                data-phone="@customer.Phone">
                            @customer.Name
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label for="CustomerOib" class="form-label">OIB</label>
                <input type="text" id="CustomerOib" name="CustomerOib" class="form-control" maxlength="11" pattern="\d{11}"
                       title="OIB mora sadržavati točno 11 znamenki" required value="@Model.CustomerOib" />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="CustomerName" class="form-label">Ime i prezime / Naziv</label>
                <input type="text" id="CustomerName" name="CustomerName" class="form-control" required
                       value="@Model.CustomerName" />
            </div>
            <div class="col-md-6">
                <label for="CustomerStreet" class="form-label">Ulica i broj</label>
                <input type="text" id="CustomerStreet" name="CustomerStreet" class="form-control" required
                       value="@Model.CustomerStreet" />
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="CustomerPostalCode" class="form-label">Poštanski broj</label>
                <input type="text" id="CustomerPostalCode" name="CustomerPostalCode" class="form-control" required
                       value="@Model.CustomerPostalCode" />
            </div>
            <div class="col-md-6">
                <label for="CustomerCity" class="form-label">Mjesto</label>
                <input type="text" id="CustomerCity" name="CustomerCity" class="form-control" required
                       value="@Model.CustomerCity" />
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="CustomerEmail" class="form-label">Email</label>
                <input type="email" id="CustomerEmail" name="CustomerEmail" class="form-control" required
                       value="@Model.CustomerEmail" />
            </div>
            <div class="col-md-6">
                <label for="CustomerPhone" class="form-label">Telefon</label>
                <input type="tel" id="CustomerPhone" name="CustomerPhone" class="form-control"
                       value="@Model.CustomerPhone" />
            </div>
        </div>

        <h3>Detalji računa</h3>

        <div class="row mb-3">
            <div class="col-md-12">
                <label for="PdfFilePath" class="form-label">PDF putanja (samo za stare račune)</label>
                <input type="text" id="PdfFilePath" name="PdfFilePath" class="form-control"
                       placeholder="../invoices/2025/račun123.pdf" value="@Model.PdfFilePath" />
            </div>
        </div>

        <div class="mb-4">
            <label for="Note" class="form-label">Napomena</label>
            <textarea id="Note" name="Note" rows="3" class="form-control">@Model.Note</textarea>
        </div>

        <hr />

        <h4 class="mb-3">Stavke računa</h4>

        <div id="invoice-items-app">
            <table class="table table-bordered" id="itemsTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50%;">Opis</th>
                        <th style="width: 15%;">Jedinica</th>
                        <th style="width: 15%;">Količina</th>
                        <th style="width: 15%;">Cijena</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, index) in items" :key="index">
                        <td>
                            <input type="text" v-model="item.Description" :name="`Items[${index}].Description`" class="form-control" required />
                        </td>
                        <td>
                            <input type="text" v-model="item.Unit" :name="`Items[${index}].Unit`" class="form-control" placeholder="kom, kg..." required />
                        </td>
                        <td>
                            <input type="number" step="1" v-model.number="item.Quantity" :name="`Items[${index}].Quantity`" class="form-control" required @@change="calculateTotalPrice" />
                        </td>
                        <td>
                            <input type="number" step="0.1" v-model.number="item.Price" :name="`Items[${index}].Price`" class="form-control" required @@change="calculateTotalPrice" />
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger" @@click="removeItem(index)">X</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <button type="button" class="btn btn-secondary mb-4" @@click="addItem">Dodaj stavku</button>

            <div class="mb-3">
                <label><strong>Ukupno: </strong></label> <span>{{ totalAmountFormatted }}</span>
            </div>
        </div>



        <div class="row mb-3">
            <div class="col-md-6">
                <label for="Cijena_Slovima" class="form-label">Cijena slovima</label>
                <input type="text" id="Cijena_Slovima" name="Cijena_Slovima" class="form-control"
                       value="" />
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Spremi račun</button>
    </form>
</div>

@section Scripts {
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    items: [
                        { Description: '', Unit: '', Quantity: 1, Price: 0 }
                    ],
                    totalAmountFormatted: '0,00 €' 
                }
            },
            computed: {
                totalAmount() {
                    return this.items.reduce((sum, item) => sum + (item.Quantity * item.Price || 0), 0);
                },
                totalAmountFormattedComputed() {
                    return this.totalAmountFormatted; 
                }
            },
            methods: {
                async calculateTotalPrice() {
                    try {
                        const response = await fetch('/api/Api/CalculateTotalAmount', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.items)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Server error:', errorText);
                            return;
                        }

                        const data = await response.json();
                        this.totalAmountFormatted = data.totalAmountFormatted;

                    } catch (error) {
                        console.error('Greška prilikom izračuna:', error);
                    }
                },
                addItem() {
                    this.items.push({ Description: '', Unit: '', Quantity: 1, Price: 0 });
                    this.calculateTotalPrice();
                },
                removeItem(index) {
                    this.items.splice(index, 1);
                    this.calculateTotalPrice();
                },
                onItemChange() {
                    this.calculateTotalPrice();
                }
            },
            mounted() {
                this.calculateTotalPrice();
            }
        }).mount('#invoice-items-app');

    </script>

}
