@model _2DRakun.Models.ViewModels.InvoiceViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Kreiranje računa";
}

<div class="invoice-create shadow-sm rounded bg-white p-4">
    <h2 class="text-center mb-4">Novi račun</h2>

    <form method="post" action="@Url.Action("CreateInvoice", "Home")" novalidate>
        @Html.AntiForgeryToken()

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="InvoiceNumber" class="form-label">Broj računa</label>
                <input type="text" id="InvoiceNumber" name="InvoiceNumber" class="form-control" required
                       value="@Model.InvoiceNumber" />
            </div>
        </div>

        <h3>Podaci o kupcu</h3>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="CustomerId" class="form-label">Kupac</label>
                <select id="CustomerId" name="CustomerId" class="form-select" required>
                    <option value="" selected>Odaberite kupca</option>
                    @foreach (var customer in Model.ExistingCustomers)
                    {
                        <option value="@customer.Id"
                                data-oib="@customer.Oib"
                                data-name="@customer.Name"
                                data-street="@customer.Street"
                                data-postal="@customer.PostalCode"
                                data-city="@customer.City"
                                data-email="@customer.Email"
                                data-phone="@customer.Phone">
                            @customer.Name
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label for="CustomerOib" class="form-label">OIB</label>
                <input type="text" id="CustomerOib" name="CustomerOib" class="form-control" maxlength="11" pattern="\d{11}"
                       title="OIB mora sadržavati točno 11 znamenki" required value="@Model.CustomerOib" />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="CustomerName" class="form-label">Ime i prezime / Naziv</label>
                <input type="text" id="CustomerName" name="CustomerName" class="form-control" required
                       value="@Model.CustomerName" />
            </div>
            <div class="col-md-6">
                <label for="CustomerStreet" class="form-label">Ulica i broj</label>
                <input type="text" id="CustomerStreet" name="CustomerStreet" class="form-control" required
                       value="@Model.CustomerStreet" />
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="CustomerPostalCode" class="form-label">Poštanski broj</label>
                <input type="text" id="CustomerPostalCode" name="CustomerPostalCode" class="form-control" required
                       value="@Model.CustomerPostalCode" />
            </div>
            <div class="col-md-6">
                <label for="CustomerCity" class="form-label">Mjesto</label>
                <input type="text" id="CustomerCity" name="CustomerCity" class="form-control" required
                       value="@Model.CustomerCity" />
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="CustomerEmail" class="form-label">Email</label>
                <input type="email" id="CustomerEmail" name="CustomerEmail" class="form-control" required
                       value="@Model.CustomerEmail" />
            </div>
            <div class="col-md-6">
                <label for="CustomerPhone" class="form-label">Telefon</label>
                <input type="tel" id="CustomerPhone" name="CustomerPhone" class="form-control"
                       value="@Model.CustomerPhone" />
            </div>
        </div>

        <h3>Detalji računa</h3>

        <div class="row mb-3">
            <div class="col-md-12">
                <label for="PdfFilePath" class="form-label">PDF putanja (samo za stare račune)</label>
                <input type="text" id="PdfFilePath" name="PdfFilePath" class="form-control"
                       placeholder="../invoices/2025/račun123.pdf" value="@Model.PdfFilePath" />
            </div>
        </div>

        <div class="mb-4">
            <label for="Note" class="form-label">Napomena</label>
            <textarea id="Note" name="Note" rows="3" class="form-control">@Model.Note</textarea>
        </div>

        <hr />

        <h4 class="mb-3">Stavke računa</h4>

        <table class="table table-bordered" id="itemsTable">
            <thead class="table-light">
                <tr>
                    <th style="width: 50%;">Opis</th>
                    <th style="width: 15%;">Jedinica</th>
                    <th style="width: 15%;">Količina</th>
                    <th style="width: 15%;">Cijena</th>
                    <th style="width: 5%;"></th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                @if (Model.Items != null && Model.Items.Any())
                {
                    for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td>
                                <input type="text" name="Items[@i].Description" class="form-control" required value="@Model.Items[i].Description" />
                            </td>
                            <td>
                                <input type="text" name="Items[@i].Unit" class="form-control" placeholder="kom, kg..." required value="@Model.Items[i].Unit" />
                            </td>
                            <td>
                                <input type="number" step="0.01" name="Items[@i].Quantity" class="form-control" required value="@Model.Items[i].Quantity" />
                            </td>
                            <td>
                                <input type="number" step="0.01" name="Items[@i].Price" class="form-control" required value="@Model.Items[i].Price" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-danger remove-btn">X</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <button type="button" class="btn btn-secondary mb-4" id="addItemBtn">Dodaj stavku</button>

        <div class="mb-3">
            <label><strong>Ukupno:</strong></label>
            <span id="totalAmount">0,00 €</span>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="Cijena_Slovima" class="form-label">Cijena slovima</label>
                <input type="text" id="Cijena_Slovima" name="Cijena_Slovima" class="form-control"
                       value="" />
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Spremi račun</button>
    </form>
</div>

@section Scripts {
    <script>
        let itemIndex = @((Model.Items != null) ? Model.Items.Count : 0);

        function resetItemIndices() {
            const rows = document.querySelectorAll("#itemsBody tr");
            rows.forEach((row, index) => {
                row.querySelectorAll("input").forEach(input => {
                    const name = input.getAttribute("name");
                    if (!name) return;
                    const newName = name.replace(/Items\[\d+\]/, `Items[${index}]`);
                    input.setAttribute("name", newName);
                });
            });
            itemIndex = rows.length;
        }

        document.getElementById("addItemBtn").addEventListener("click", function () {
            const tbody = document.getElementById("itemsBody");
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>
                    <input type="text" name="Items[${itemIndex}].Description" class="form-control" required />
                </td>
                <td>
                    <input type="text" name="Items[${itemIndex}].Unit" class="form-control" placeholder="kom, kg..." required />
                </td>
                <td>
                    <input type="number" step="0.01" name="Items[${itemIndex}].Quantity" class="form-control" required />
                </td>
                <td>
                    <input type="number" step="0.01" name="Items[${itemIndex}].Price" class="form-control" required />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger remove-btn">X</button>
                </td>
            `;

            tbody.appendChild(row);
            itemIndex++;
        });

        document.getElementById("itemsBody").addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-btn")) {
                e.target.closest("tr").remove();
                resetItemIndices();
            }
        });

    </script>  

}
